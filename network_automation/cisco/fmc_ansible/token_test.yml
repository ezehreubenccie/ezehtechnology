- name: Authenticate with FMC
  hosts: localhost
  # connection: httpapi
  vars:
    fmc_host: wa-fmc2500
  vars_files:
    - ~/cisco/fmc_ansible/host_vars/wa-fmc2500/creds.yml
    # ansible_user: apiuser
    # ansible_password: XXXX
  tasks:
    - name: Get authentication token
      uri:
        url: "https://{{ fmc_host }}/api/fmc_platform/v1/auth/generatetoken"
        method: POST
        headers:
          Content-Type: application/json
        user: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: 204
      register: auth_response

    - name: Debug authentication token
      debug:
        var: auth_response


    - name: Extract token
      set_fact:
        fmc_token: "{{ auth_response['x_auth_access_token'] }}"

    - name: Debug Token
      debug:
        var: fmc_token
